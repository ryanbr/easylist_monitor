name: EasyList Monitor

on:
  schedule:
    # Run every hour, but script will enforce 90-minute intervals
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual triggering
  push:
    paths:
      - '.github/workflows/easylist-monitor.yml'
      - 'scripts/easylist-monitor.js'

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install @actions/core

      - name: Run EasyList monitor
        id: monitor
        run: |
          cd scripts
          node easylist-monitor.js
        continue-on-error: false

      - name: Debug monitor outputs
        run: |
          echo "=== DEBUG: Monitor Outputs ==="
          echo "has_updates: ${{ steps.monitor.outputs.has_updates }}"
          echo "is_stale_commit: ${{ steps.monitor.outputs.is_stale_commit }}"
          echo "updated_count: ${{ steps.monitor.outputs.updated_count }}"
          echo "commit_message: ${{ steps.monitor.outputs.commit_message }}"

      - name: Configure Git
        if: steps.monitor.outputs.has_updates == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Commit and push changes
        if: steps.monitor.outputs.has_updates == 'true'
        run: |
          # Pull latest changes first to avoid conflicts
          git pull origin main
          
          if [ "${{ steps.monitor.outputs.is_stale_commit }}" == "true" ]; then
            echo "Committing stale file report..."
            git add scripts/stale-files-report.json
            if [ -f scripts/metadata.json ]; then
              git add scripts/metadata.json
            fi
          else
            echo "Committing regular updates..."
            git add scripts/lists/ scripts/hashes.json scripts/metadata.json scripts/update-summary.json
          fi
          git commit -m "${{ steps.monitor.outputs.commit_message }}"
          git push

      - name: Send email notification for stale files
        if: steps.monitor.outputs.has_updates == 'true' && steps.monitor.outputs.is_stale_commit == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "EasyList Stale Files Alert - Monitoring Report"
          to: mp3geek@gmail.com
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            Hello EasyList Team,

            Our automated monitoring system has detected that EasyList files appear to be stale and have not been updated recently.

            DETECTED ISSUES:
            - Files have not been updated for more than 24 hours
            - Last modification detected: September 1, 2025
            - Current monitoring time: ${{ github.event.repository.updated_at }}

            FILES AFFECTED:
            - easylist.txt
            - easyprivacy.txt

            EXPECTED BEHAVIOR:
            - EasyList files should update within 24 hours
            - Current age exceeds expected update frequency

            This could indicate:
            - Server infrastructure issues
            - Update pipeline problems
            - Publishing system failures

            Please investigate your update systems and publishing pipeline.

            ---
            This notification was sent automatically by: ${{ github.repository }}
            Monitoring workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Summary
        run: |
          echo "## EasyList Monitor Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Has updates:** ${{ steps.monitor.outputs.has_updates }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Updated lists:** ${{ steps.monitor.outputs.updated_count }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.monitor.outputs.has_updates }}" == "true" ]; then
            echo "- **Commit message:** ${{ steps.monitor.outputs.commit_message }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Is stale commit:** ${{ steps.monitor.outputs.is_stale_commit }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY